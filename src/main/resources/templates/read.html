<!DOCTYPE html>
<html>
    <head>
        <title>Read | Vicuna</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        {{> common/style}}
    </head>
    <body class="bootstrap-admin-with-small-navbar">
        <!-- small navbar -->
        {{> common/small_navbar}}

        <!-- main / large navbar -->
        {{> common/main_navbar}}

        <div class="container">
            <!-- left, vertical navbar & content -->
            <div class="row">
                <!-- left, vertical navbar -->
                {{> common/left_navbar}}

                <!-- content -->
                <div class="col-md-10">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="alert alert-success bootstrap-admin-alert">
                                <button type="button" class="close" data-dismiss="alert">Ã—</button>
                                <h4>Success</h4>
                                The operation completed successfully
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="page-header">
                                <h1>Read & Parse Damage Mail</h1>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="panel panel-default  bootstrap-admin-no-table-panel">
                                <div class="panel-heading">
                                    <div class="text-muted bootstrap-admin-box-title">Read Gmail</div>
                                </div>
                                <div class="bootstrap-admin-panel-content bootstrap-admin-no-table-panel-content collapse in" style="padding: 10px 0; text-align: center">
                                    <div id="connect-container">
                                        <div>
                                            <div class="easyPieChart" data-percent="0" style="width: 110px; height: 110px; line-height: 110px;"><span class="percent">0</span>%</div>
                                            <div class="chart-bottom-heading"><span class="label label-info">GmailReading</span></div>
                                        </div>
                                        <div>
                                            <button id="start" class="btn btn-primary">Start</button>
                                            <button id="status" class="btn btn-primary">Status</button>
                                        </div>
                                    </div>
                                    <a href="#" class="button updatePieCharts">Update pie charts</a>
<div id="connected" style="display:none">
<div class="page-header">
  <h2>Debug Room</h2>
</div>
<div id="messages">
</div>
</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- footer -->
        {{> common/footer}}
        {{> common/script}}
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
<script type="text/javascript">
    var stompClient = null; 
    $(function() {
        var socket = new SockJS("/readGmail");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            $('#connected').fadeIn();
            stompClient.subscribe('/topic/start', function(calResult){
            	readStart(JSON.parse(calResult.body).totalCount);
            });
            stompClient.subscribe('/topic/status', function(calResult){
            	readStatus(JSON.parse(calResult.body).processCount);
            });
        });
        
        /*
        ws.onopen = function () {};
        ws.onmessage = function (event) {
        	var val = event.data;
            $('.easyPieChart').data('easyPieChart').update(val);
            $('.percent').text(val);
        	if (val == '100') {
                clearTimeout(timerID);
                ws.close();
        	}
        };
        ws.onclose = function () {};
        */

        // Easy pie charts
        $('.easyPieChart').easyPieChart({
            animate: 1000,
            barColor: function(percent) {
                percent /= 100;
                return "rgb(" + Math.round(255 * (1-percent)) + ", " + Math.round(255 * percent) + ", 0)";
            },
            size: 200,
            lineWidth: 20,
            trackWidth: 15 
        });

        $('.updatePieCharts').on('click', function(e) {
            e.preventDefault();
            var newValue = Math.floor(100 * Math.random());
            $('.easyPieChart').data('easyPieChart').update(newValue);
            $('.percent').text(newValue);
        });
        
        $('#start').on('click', function(e) {
            stompClient.send("/app/read/start", {}, {});
        });
        $('#status').on('click', function(e) {
            stompClient.send("/app/read/status", {}, {});
        });
    });
    
    /*
    var timerID;
    function status() {
        if (ws != null) {
            ws.send("status");
            timerID = setTimeout(status, 5000); 
        } else {
            alert('WebSocket connection not established, please connect.');
        }
    }
    */
    function readStart(msg) {
    	 $("#messages").html(msg);	
    }
    function readStatus(msg) {
    	 $("#messages").html(msg);	
    }
</script>
    </body>
</html>
